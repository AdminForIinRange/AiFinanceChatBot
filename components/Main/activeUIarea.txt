"use client"

import type React from "react"
import { useState, useEffect, useRef } from "react"
import { Box, Text, HStack, VStack } from "@chakra-ui/react"
import { Send, ChevronDown, BarChart2, Clock, AlertCircle, CheckCircle, Zap } from "lucide-react"
import ChatArea from "./chatArea"
import ReactMarkdown from "react-markdown"
import LowerNavigationBoxes from "./lowerNavigationBoxes"

// TradingView-inspired theme colors
const theme = {
  bg: {
    primary: "#131722",
    secondary: "#1E222D",
    tertiary: "#2A2E39",
    input: "#2A2E39",
    accent: "#242732",
  },
  text: {
    primary: "#D9D9D9",
    secondary: "#9CA3AF",
    muted: "#6B7280",
  },
  accent: {
    blue: "#2962FF",
    green: "#26A69A",
    red: "#EF5350",
    yellow: "#F9A825",
    purple: "#7B1FA2",
  },
  border: {
    light: "#363A45",
    medium: "#4A4F5C",
  },
}

const LoadingIndicator = () => {
  const [progress, setProgress] = useState(0)

  useEffect(() => {
    const interval = setInterval(() => {
      setProgress((prev) => (prev >= 100 ? 0 : prev + 4))
    }, 150)
    return () => clearInterval(interval)
  }, [])

  return (
    <HStack spacing={2} align="center" my={1}>
      <Box w="100%" h="2px" bg={theme.border.light} borderRadius="full" overflow="hidden">
        <Box h="100%" w={`${progress}%`} bg={theme.accent.blue} transition="width 0.2s ease" borderRadius="full" />
      </Box>
      <Text fontSize="xs" color={theme.text.secondary}>
        {progress < 100 ? "Processing" : "Analyzing market data"}
      </Text>
    </HStack>
  )
}

const MessageTimestamp = ({ date }: { date: Date }) => {
  const formatTime = (date: Date) => {
    return date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
  }

  return (
    <HStack spacing={1} opacity={0.7}>
      <Clock size={12} />
      <Text fontSize="xs" color={theme.text.secondary}>
        {formatTime(date)}
      </Text>
    </HStack>
  )
}

const ActiveChatArea = () => {
  const [input, setInput] = useState("")
  const [messages, setMessages] = useState<
    {
      from: string
      text: string
      loading?: boolean
      timestamp: Date
      sentiment?: "neutral" | "positive" | "negative"
    }[]
  >([])
  const [isAiPrompting, setIsAiPrompting] = useState(false)
  const messagesEndRef = useRef<HTMLDivElement>(null)
  const inputRef = useRef<HTMLInputElement>(null)
  const [showWelcome, setShowWelcome] = useState(true)

  // Sample welcome message
  useEffect(() => {
    if (isAiPrompting && messages.length === 0) {
      setMessages([
        {
          from: "VelvoTrade",
          text: "Welcome to VelvoTrade AI Assistant. I can help you with market analysis, trading strategies, and investment insights. What would you like to know today?",
          timestamp: new Date(),
          sentiment: "neutral",
        },
      ])
    }
  }, [isAiPrompting, messages.length])

  // Scroll to bottom whenever messages change
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" })
  }, [messages])

  // Focus input on load
  useEffect(() => {
    if (isAiPrompting) {
      inputRef.current?.focus()
    }
  }, [isAiPrompting])

  const sendPrompt = async (currentInput: string) => {
    // Determine sentiment based on keywords (simplified example)
    const sentiment = currentInput.match(/buy|profit|gain|up|bull/i)
      ? "positive"
      : currentInput.match(/sell|loss|down|bear|crash/i)
        ? "negative"
        : "neutral"

    setMessages((prev) => [
      ...prev,
      { from: "User", text: currentInput, timestamp: new Date(), sentiment },
      { from: "VelvoTrade", text: "thinking", loading: true, timestamp: new Date(), sentiment: "neutral" },
    ])
    setIsAiPrompting(true)
    setShowWelcome(false)

    try {
      const response = await fetch("/api/gemini", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: currentInput }),
      })
      const data = await response.json()

      // Determine AI response sentiment (simplified)
      const responseSentiment = data.response?.match(/increase|profit|gain|up|bull|positive/i)
        ? "positive"
        : data.response?.match(/decrease|loss|down|bear|negative|crash/i)
          ? "negative"
          : "neutral"

      setMessages((prev) =>
        prev.map((msg, idx) =>
          idx === prev.length - 1
            ? {
                from: "VelvoTrade",
                text: data.response || data.result,
                timestamp: new Date(),
                sentiment: responseSentiment,
              }
            : msg,
        ),
      )
    } catch (error) {
      console.error("Error:", error)
      setMessages((prev) =>
        prev.map((msg, idx) =>
          idx === prev.length - 1
            ? {
                from: "VelvoTrade",
                text: "Error fetching response. Please try again.",
                timestamp: new Date(),
                sentiment: "negative",
              }
            : msg,
        ),
      )
    }
  }

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === "Enter" && input.trim().length > 0) {
      sendPrompt(input)
      setInput("") // Clear input after sending
    }
  }

  return (
    <Box bg={theme.bg.primary} minH="100vh" color={theme.text.primary} position="relative" overflow="hidden">
      {/* Header */}
      <Box
        position="sticky"
        top={0}
        zIndex={10}
        bg={theme.bg.secondary}
        borderBottom={`1px solid ${theme.border.light}`}
        px={6}
        py={3}
      >
        <HStack justify="space-between" maxW="1400px" mx="auto">
          <HStack spacing={3}>
            <Box
              bg={theme.accent.blue}
              color="white"
              p={1}
              borderRadius="md"
              display="flex"
              alignItems="center"
              justifyContent="center"
            >
              <Zap size={16} />
            </Box>
            <Text fontWeight="bold">AI Trading Assistant</Text>
          </HStack>
          <HStack spacing={4}>
            <Box
              as="button"
              display="flex"
              alignItems="center"
              px={3}
              py={1}
              borderRadius="md"
              bg={theme.bg.tertiary}
              _hover={{ bg: theme.accent.blue, color: "white" }}
              transition="all 0.2s"
            >
              <BarChart2 size={14} />
              <Text ml={2} fontSize="sm">
                Market Data
              </Text>
            </Box>
            <Box
              as="button"
              display="flex"
              alignItems="center"
              px={3}
              py={1}
              borderRadius="md"
              bg={theme.bg.tertiary}
              _hover={{ bg: theme.accent.blue, color: "white" }}
              transition="all 0.2s"
            >
              <Text fontSize="sm">BTC/USD</Text>
              <Text ml={1} fontSize="sm" color={theme.accent.green}>
                48,235.50
              </Text>
              <ChevronDown size={14} />
            </Box>
          </HStack>
        </HStack>
      </Box>

      {/* Main Content Area */}
      <Box
        px={["4%", "4%", "6%", "6%", "6%", "10%"]}
        pt={4}
        pb="120px" // Space for the input area
      >
        <Box display={isAiPrompting ? "none" : "block"}>
          <ChatArea />
        </Box>

        {isAiPrompting && (
          <VStack
            w="100%"
            spacing={6}
            align="stretch"
            maxW="1400px"
            mx="auto"
            h="calc(100vh - 200px)"
            overflowY="auto"
            css={{
              "&::-webkit-scrollbar": {
                width: "6px",
              },
              "&::-webkit-scrollbar-track": {
                background: theme.bg.secondary,
              },
              "&::-webkit-scrollbar-thumb": {
                background: theme.border.medium,
                borderRadius: "3px",
              },
              "&::-webkit-scrollbar-thumb:hover": {
                background: theme.accent.blue,
              },
            }}
            px={2}
            pt={4}
          >
            {/* Welcome card */}
            {showWelcome && (
              <Box
                bg={theme.bg.secondary}
                borderRadius="lg"
                p={6}
                border={`1px solid ${theme.border.light}`}
                mb={6}
                boxShadow="0 4px 20px rgba(0,0,0,0.2)"
                maxW="900px"
                mx="auto"
              >
                <HStack spacing={4} mb={4}>
                  <Box
                    bg={theme.accent.blue}
                    p={3}
                    borderRadius="lg"
                    display="flex"
                    alignItems="center"
                    justifyContent="center"
                  >
                    <BarChart2 size={24} />
                  </Box>
                  <Box>
                    <Text fontSize="xl" fontWeight="bold">
                      VelvoTrade AI Assistant
                    </Text>
                    <Text color={theme.text.secondary}>Your personal trading and market analysis companion</Text>
                  </Box>
                </HStack>

                <Text mb={4}>
                  Ask me about market trends, trading strategies, technical analysis, or specific assets. I'm here to
                  help with your trading decisions.
                </Text>

                <VStack align="stretch" spacing={2}>
                  {[
                    "What's your analysis on Bitcoin's current trend?",
                    "Explain the RSI indicator and how to use it",
                    "What trading strategy would you recommend for volatile markets?",
                  ].map((suggestion, i) => (
                    <Box
                      key={i}
                      as="button"
                      onClick={() => {
                        setInput(suggestion)
                        sendPrompt(suggestion)
                      }}
                      bg={theme.bg.tertiary}
                      p={3}
                      borderRadius="md"
                      textAlign="left"
                      _hover={{ bg: theme.bg.accent }}
                      transition="all 0.2s"
                      border={`1px solid ${theme.border.light}`}
                    >
                      <Text>{suggestion}</Text>
                    </Box>
                  ))}
                </VStack>
              </Box>
            )}

            {messages.map((msg, idx) => {
              const isUser = msg.from === "User"
              const sentimentColor =
                msg.sentiment === "positive"
                  ? theme.accent.green
                  : msg.sentiment === "negative"
                    ? theme.accent.red
                    : theme.accent.blue

              return (
                <Box
                  key={idx}
                  alignSelf={isUser ? "flex-end" : "flex-start"}
                  maxW={["95%", "90%", "85%", "75%"]}
                  opacity={0}
                  animation="fadeIn 0.3s forwards"
                  sx={{
                    "@keyframes fadeIn": {
                      "0%": { opacity: 0, transform: "translateY(10px)" },
                      "100%": { opacity: 1, transform: "translateY(0)" },
                    },
                    animationDelay: `${idx * 0.1}s`,
                  }}
                  mb={4}
                >
                  <HStack spacing={2} justify={isUser ? "flex-end" : "flex-start"} mb={1}>
                    <Box
                      w="28px"
                      h="28px"
                      borderRadius="md"
                      bg={isUser ? theme.bg.tertiary : theme.bg.tertiary}
                      border={`1px solid ${isUser ? theme.accent.blue : sentimentColor}`}
                      display="flex"
                      alignItems="center"
                      justifyContent="center"
                      fontSize="12px"
                      fontWeight="bold"
                      order={isUser ? 2 : 1}
                    >
                      {isUser ? "U" : "AI"}
                    </Box>
                    <Text fontSize="xs" color={theme.text.secondary} order={isUser ? 1 : 2}>
                      {msg.from}
                    </Text>
                    <Box order={isUser ? 3 : 3}>
                      <MessageTimestamp date={msg.timestamp} />
                    </Box>
                  </HStack>

                  <Box
                    bg={isUser ? theme.bg.tertiary : theme.bg.secondary}
                    p={4}
                    borderRadius="md"
                    boxShadow="0 2px 10px rgba(0,0,0,0.1)"
                    borderLeft={!isUser ? `2px solid ${sentimentColor}` : "none"}
                    borderRight={isUser ? `2px solid ${theme.accent.blue}` : "none"}
                    position="relative"
                  >
                    {msg.loading ? (
                      <Box>
                        <Text mb={2} fontWeight="medium">
                          Analyzing your request...
                        </Text>
                        <LoadingIndicator />
                      </Box>
                    ) : (
                      <Box
                        className="message-content"
                        fontSize="15px"
                        lineHeight="1.6"
                        css={{
                          "& p": {
                            margin: "0.5em 0",
                          },
                          "& code": {
                            backgroundColor: theme.bg.primary,
                            padding: "0.2em 0.4em",
                            borderRadius: "4px",
                            fontSize: "0.9em",
                            fontFamily: "monospace",
                          },
                          "& pre": {
                            backgroundColor: theme.bg.primary,
                            padding: "1em",
                            borderRadius: "4px",
                            overflowX: "auto",
                            margin: "0.5em 0",
                            border: `1px solid ${theme.border.light}`,
                          },
                          "& a": {
                            color: theme.accent.blue,
                            textDecoration: "underline",
                          },
                          "& ul, & ol": {
                            paddingLeft: "1.5em",
                            margin: "0.5em 0",
                          },
                          "& strong": {
                            color: isUser ? theme.accent.blue : sentimentColor,
                          },
                          "& h1, & h2, & h3, & h4": {
                            borderBottom: `1px solid ${theme.border.light}`,
                            paddingBottom: "0.3em",
                            marginTop: "1em",
                          },
                          "& table": {
                            borderCollapse: "collapse",
                            width: "100%",
                            margin: "1em 0",
                          },
                          "& th, & td": {
                            border: `1px solid ${theme.border.light}`,
                            padding: "0.5em",
                          },
                          "& th": {
                            backgroundColor: theme.bg.tertiary,
                          },
                        }}
                      >
                        {msg.from === "VelvoTrade" ? (
                          <ReactMarkdown>{msg.text}</ReactMarkdown>
                        ) : (
                          <Text>{msg.text}</Text>
                        )}
                      </Box>
                    )}

                    {!isUser && !msg.loading && (
                      <HStack mt={3} pt={2} borderTop={`1px solid ${theme.border.light}`} spacing={4}>
                        <Box
                          as="button"
                          display="flex"
                          alignItems="center"
                          fontSize="xs"
                          color={theme.text.secondary}
                          _hover={{ color: theme.accent.blue }}
                        >
                          <CheckCircle size={14} />
                          <Text ml={1}>Helpful</Text>
                        </Box>
                        <Box
                          as="button"
                          display="flex"
                          alignItems="center"
                          fontSize="xs"
                          color={theme.text.secondary}
                          _hover={{ color: theme.accent.red }}
                        >
                          <AlertCircle size={14} />
                          <Text ml={1}>Not helpful</Text>
                        </Box>
                      </HStack>
                    )}
                  </Box>
                </Box>
              )
            })}
            <Box ref={messagesEndRef} />
          </VStack>
        )}
      </Box>

      {/* Fixed input area at bottom */}
      <Box
        position="fixed"
        bottom={0}
        left={0}
        right={0}
        bg={`linear-gradient(to top, ${theme.bg.primary} 85%, transparent)`}
        py={6}
        px={["4%", "4%", "6%", "6%", "6%", "10%"]}
        zIndex={1000}
      >
        <VStack maxW="1400px" mx="auto" spacing={3}>
          <HStack
            w="100%"
            spacing={3}
            bg={theme.bg.secondary}
            p={2}
            borderRadius="md"
            boxShadow="0 4px 20px rgba(0, 0, 0, 0.3)"
            border={`1px solid ${theme.border.light}`}
          >
            <Box
              as="input"
              ref={inputRef}
              autoFocus
              type="text"
              placeholder="Ask about market analysis, trading strategies, or technical indicators..."
              w="100%"
              height="50px"
              value={input}
              bg={theme.bg.input}
              onChange={(e: React.ChangeEvent<HTMLInputElement>) => setInput(e.target.value)}
              onKeyDown={handleKeyDown}
              border={`1px solid ${theme.border.light}`}
              _focus={{
                border: `1px solid ${theme.accent.blue}`,
                boxShadow: `0 0 0 1px ${theme.accent.blue}`,
                outline: "none",
              }}
              _hover={{
                border: `1px solid ${theme.border.medium}`,
              }}
              color={theme.text.primary}
              borderRadius="md"
              fontSize="15px"
              px={4}
              transition="all 0.2s ease"
            />
            <Box
              onClick={() => {
                if (input.trim().length > 0) {
                  sendPrompt(input)
                  setInput("")
                }
              }}
              as="button"
              display="flex"
              justifyContent="center"
              alignItems="center"
              minWidth="50px"
              height="50px"
              bg={input.trim().length > 0 ? theme.accent.blue : theme.bg.tertiary}
              borderRadius="md"
              _hover={{
                bg: input.trim().length > 0 ? "#1E53E5" : theme.bg.tertiary,
                transform: input.trim().length > 0 ? "translateY(-2px)" : "none",
              }}
              _active={{
                transform: "translateY(0)",
              }}
              transition="all 0.2s ease"
              cursor={input.trim().length > 0 ? "pointer" : "not-allowed"}
              aria-label="Send message"
            >
              <Send size={18} color={input.trim().length > 0 ? "white" : theme.text.secondary} />
            </Box>
          </HStack>

          <HStack spacing={2} justify="center">
            <Box
              w="8px"
              h="8px"
              borderRadius="full"
              bg={theme.accent.green}
              animation="pulse 2s infinite"
              sx={{
                "@keyframes pulse": {
                  "0%": { opacity: 0.4 },
                  "50%": { opacity: 1 },
                  "100%": { opacity: 0.4 },
                },
              }}
            />
            <Text color={theme.text.secondary} fontSize="xs">
              AI Assistant is online and ready to help with your trading questions
            </Text>
          </HStack>
        </VStack>
      </Box>

      <LowerNavigationBoxes />
    </Box>
  )
}

export default ActiveChatArea
